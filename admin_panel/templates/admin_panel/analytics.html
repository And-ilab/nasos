{% extends 'base/layout.html' %}
{% load custom_filters %}
{% block title %}Аналитика успеваемости{% endblock %}

{% block content %}
<div class="analytics-wrapper">
    <!-- Сайдбар с отчетами -->
    <div class="analytics-sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-graph-up"></i> Аналитические отчеты</h3>
        </div>
        <div class="sidebar-buttons">
            <button id="btn-learning-report" class="btn sidebar-btn active">
                <i class="bi bi-journal-bookmark"></i> Отчет об обучении
            </button>
            <button id="btn-testing-report" class="btn sidebar-btn">
                <i class="bi bi-clipboard-data"></i> Отчет о тестировании
            </button>
            <button id="btn-activity-report" class="btn sidebar-btn">
                <i class="bi bi-activity"></i> Активность студентов
            </button>
        </div>
    </div>

    <!-- Основное содержимое -->
    <div class="analytics-content">
        <div class="content-header">
            <h3 id="report-title">Отчет об обучении</h3>
            <div class="analytics-tools">
                <!-- Фильтры -->
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel"></i> Фильтры
                    </button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">Период</h6></li>
                        <li><a class="dropdown-item filter-period active" data-period="month">За месяц</a></li>
                        <li><a class="dropdown-item filter-period" data-period="week">За неделю</a></li>
                        <li><a class="dropdown-item filter-period" data-period="day">Сегодня</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><h6 class="dropdown-header">Группа</h6></li>
                        <li>
                            <select class="form-select form-select-sm" id="group-filter">
                                <option value="all">Все группы</option>
                                {% for group in groups %}
                                <option value="{{ group }}">Группа {{ group }}</option>
                                {% endfor %}
                            </select>
                        </li>
                    </ul>
                </div>

                <!-- Типы визуализации -->
                <div class="btn-group visualization-tools">
                    <button class="btn btn-outline-primary active" data-type="chart">
                        <i class="bi bi-bar-chart"></i>
                    </button>
                    <button class="btn btn-outline-primary" data-type="table">
                        <i class="bi bi-table"></i>
                    </button>
                </div>

                <!-- Экспорт -->
                <button class="btn btn-success" id="export-btn">
                    <i class="bi bi-download"></i> Экспорт
                </button>
            </div>
        </div>

        <!-- Контейнер для данных -->
        <div class="analytics-data">
            <!-- Графики будут здесь -->
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>

            <!-- Таблица будет здесь -->
            <div class="table-container d-none">
                <div class="table-responsive">
                    <table class="table table-hover" id="dataTable">
                        <thead class="table-light">
                        <tr>
                            <th>Студент</th>
                            <th>Группа</th>
                            <th>Оценка</th>
                            <th>Прогресс</th>
                            <th>Последняя активность</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.last_name }} {{ student.first_name }}</td>
                            <td>{{ student.group_number }}</td>
                            <td>
                                    <span class="badge bg-{{ student.scores|score_color }}">
                                        {{ student.scores|default:"-" }}
                                    </span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped"
                                         style="width: {{ student.progress }}%">
                                        {{ student.progress }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ student.last_activity|date:"d.m.Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .analytics-wrapper {
        display: flex;
        min-height: calc(100vh - 70px);
    }

    .analytics-sidebar {
        width: 250px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 15px;
    }

    .sidebar-header {
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 15px;
    }

    .sidebar-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sidebar-btn {
        text-align: left;
        padding: 10px 15px;
        transition: all 0.3s;
    }

    .sidebar-btn.active {
        background: #0d6efd;
        color: white;
    }

    .analytics-content {
        flex: 1;
        padding: 20px;
    }

    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .analytics-tools {
        display: flex;
        gap: 10px;
    }

    .chart-container {
        height: 500px;
        margin-top: 20px;
    }

    .table-container {
        margin-top: 20px;
    }

    .progress {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    $(document).ready(function () {
        // Инициализация главного графика
        const ctx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10
                    }
                }
            }
        });

        // Переключение между отчетами
        $('.sidebar-btn').click(function () {
            $('.sidebar-btn').removeClass('active');
            $(this).addClass('active');
            $('#report-title').text($(this).text().trim());
            updateReportData();
        });

        // Переключение между графиком и таблицей
        $('.visualization-tools button').click(function () {
            $('.visualization-tools button').removeClass('active');
            $(this).addClass('active');

            if ($(this).data('type') === 'chart') {
                $('.chart-container').removeClass('d-none');
                $('.table-container').addClass('d-none');
            } else {
                $('.chart-container').addClass('d-none');
                $('.table-container').removeClass('d-none');
            }
        });

        // Фильтрация данных
        $('.dropdown-menu').on('click', '.filter-period', function (e) {
            e.preventDefault();
            $('.filter-period').removeClass('active');
            $(this).addClass('active');
            updateReportData();
        });

        $('#group-filter').change(function () {
            updateReportData();
        });
        // Экспорт данных
        $('#export-btn').click(function () {
            const table = document.getElementById('dataTable');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, 'Отчет_по_студентам.xlsx');
        });

        // Функция обновления данных отчета
        function updateReportData() {
            const reportType = $('.sidebar-btn.active').attr('id');
            const period = $('.filter-period.active').data('period');
            const group = $('#group-filter').val();

            $.ajax({
                url: '/api/analytics/',
                method: 'GET',
                data: {
                    report_type: reportType,
                    period: period,
                    group: group
                },
                success: function (data) {
                    if ($('.visualization-tools .active').data('type') === 'chart') {
                        updateChart(data);
                    } else {
                        updateTable(data);
                    }
                }
            });
        }

        function updateChart(data) {
            mainChart.data.labels = data.labels;
            mainChart.data.datasets = data.datasets;
            mainChart.update();
        }

        function updateTable(data) {
            // Здесь можно обновить таблицу через AJAX если нужно
            console.log("Данные для таблицы:", data);
        }
    });
</script>
{% endblock %}