{% extends "base/layout.html" %}

{% block title %}Прохождение теста{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Режим обучение</h2>

    <div style="width: 100%; height: 600px;" id="viewer"></div>
</div>

<script src="https://unpkg.com/three@0.140.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.140.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.140.0/examples/js/loaders/MTLLoader.js"></script>
<script src="https://unpkg.com/three@0.140.0/examples/js/loaders/OBJLoader.js"></script>

<script>
  // Проверим, что OrbitControls добавился в глобальный объект THREE
  console.log('THREE:', THREE);
  console.log('THREE.OrbitControls:', THREE.OrbitControls);

  const container = document.getElementById('viewer');
  const width = container.clientWidth;
  const height = container.clientHeight;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
  camera.position.set(0, 1, 5);

  const renderer = new THREE.WebGLRenderer({antialias: true});
  renderer.setSize(width, height);
  container.appendChild(renderer.domElement);

  // Используем OrbitControls именно через THREE
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.update();

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
  directionalLight.position.set(5, 10, 7.5);
  scene.add(directionalLight);

  const mtlLoader = new THREE.MTLLoader();
  mtlLoader.setPath('/static/admin_panel/models/');
  mtlLoader.load('main_scene.mtl', (materials) => {
    materials.preload();

    const objLoader = new THREE.OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.setPath('/static/admin_panel/models/');
    objLoader.load('nasos.obj', (object) => {
      object.position.set(0, 20, -70);
      object.rotation.y = THREE.MathUtils.degToRad(90);
      object.rotation.z = THREE.MathUtils.degToRad(90);
      console.log('Модель загружена:', object);
      object.scale.set(0.1, 0.1, 0.1);
      scene.add(object);
    }, undefined, (error) => {
      console.error('Ошибка загрузки модели:', error);
    });
  }, undefined, (error) => {
    console.error('Ошибка загрузки материалов:', error);
  });

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    const width = container.clientWidth;
    const height = container.clientHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
  });
</script>

{% endblock %}
